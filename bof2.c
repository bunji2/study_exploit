#include <stdio.h>
#include <string.h>

#define SIZE 100
#define DUMP(tag,buf) printf("# %s %p: %02x%02x%02x%02x %02x%02x%02x%02x %02x%02x%02x%02x %02x%02x%02x%02x\n",\
		tag,\
		(buf),\
		*(char*)(buf)&0xFF,\
		*(char*)(buf+1)&0xFF,\
		*(char*)(buf+2)&0xFF,\
		*(char*)(buf+3)&0xFF,\
		*(char*)(buf+4)&0xFF,\
		*(char*)(buf+5)&0xFF,\
		*(char*)(buf+6)&0xFF,\
		*(char*)(buf+7)&0xFF,\
		*(char*)(buf+8)&0xFF,\
		*(char*)(buf+9)&0xFF,\
		*(char*)(buf+10)&0xFF,\
		*(char*)(buf+11)&0xFF,\
		*(char*)(buf+12)&0xFF,\
		*(char*)(buf+13)&0xFF,\
		*(char*)(buf+14)&0xFF,\
		*(char*)(buf+15)&0xFF)

#ifdef CHECK_CANARY
	#define DUMP_C(tag,buf) printf("# %s canary = 0x%08x (%02x%02x%02x%02x)\n",\
		tag,\
		*(int *)(buf+SIZE),\
		*(char*)(buf+SIZE)&0xFF,\
		*(char*)(buf+SIZE+1)&0xFF,\
		*(char*)(buf+SIZE+2)&0xFF,\
		*(char*)(buf+SIZE+3)&0xFF)
#endif /* CHECK_CANARY */


void foo(char* str) {
	char buf[SIZE] = {};
	strcpy(buf, str);
	puts(buf);
#ifdef CHECK_CANARY
	DUMP_C("foo ", buf);
#endif /* CHECK_CANARY */
}

void bar(char* str) {
	char bbb[SIZE] = {};
	strcpy(bbb, str);
	puts(bbb);
#ifdef CHECK_CANARY
	DUMP_C("bar ", bbb);
#endif /* CHECK_CANARY */
}


int main(int argc, char**argv) {
	char buf[SIZE] = {};

#ifdef CHECK_ADDR
	printf("addr of main   = %p\n", main);
	printf("addr of buf    = %p\n", buf);
	printf("addr of strcpy = %p\n", strcpy);
	printf("addr of printf = %p\n", printf);
	printf("addr of puts   = %p\n", puts);
#endif /* CHECK_ADDR */

	strcpy(buf, argv[1]);
	puts(buf);

#ifdef CHECK_STACK
	DUMP("buf     ", buf);
	DUMP("buf+0x10", buf+0x10);
	DUMP("buf+0x54", buf+SIZE-0x10);
	DUMP("buf+0x64", buf+SIZE);
	DUMP("buf+0x74", buf+SIZE+0x10);
	DUMP("buf+0x84", buf+SIZE+0x20);
#endif /* CHECK_STACK */

#ifdef CHECK_CANARY
	DUMP_C("main", buf);
#endif /* CHECK_CANARY */

	foo(argv[1]);
	bar(argv[1]);
	foo(argv[1]);

	return 0;
}
